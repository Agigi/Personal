!function(){function getSecondsFromTradeTime(t){return 3600*t.split(":")[0]+60*t.split(":")[1]+1*t.split(":")[2]}var S={version:"0.0.8"};S.$=this.jQuery||this.Zepto||this.ender||this.$,S._=this._,S.B=this.Backbone,S.w2ui=this.w2ui,S.URL_CONTRACT_LIST="/contract_list",S.URL_PRICE="/price",S.CT_STOCK="STOCK",S.CT_FUTURE="FUTURE",S.CT_OPTION="OPTION",S.CT_ADDED="ADDED",S.CT_CADDED="CADDED",S.OT_CALL="C",S.OT_PUT="P",S.PT_OPEN="OPEN",S.PT_HIGH="HIGH",S.PT_LOW="LOW",S.PT_CLOSE="CLOSE",S.PatternRegExpGeneric=/^.+$/,S.PatternContractType=/^(STOCK|FUTURE|OPTION)$/,S.PatternOptionType=/^(C|P)$/,S.PatternTickLength=/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D|1W|1N|3N|1Y)$/,S.PatternTradeDate=/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/,S.PatternTradeTime=/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/,S.PatternTradeDay=/^[0-6]$/,S.PatternUnderlyingAssetType=/^(STOCK|FUTURE)$/,S.PatternPriceType=/^(OPEN|HIGH|LOW|CLOSE)$/,S.AC_NATIVE="NATIVE",S.AC_CLONE="CLONE",S.AC_ADD="ADD",S.AC_CADD="CADD",S.AC_UL_STOCK="UL_STOCK",S.AC_UL_FUTURE="UL_FUTURE",S.AC_UL_OPTION="UL_OPTION",S._.isInteger=function(t){return S._.isNumber(t)&&Math.floor(t)==t},S.Collection2=S.B.Collection.extend({initialize:function(){this.tagNum=0,this.tagPool=S._.clone({})},getTag:function(){var t=this.tagNum;return this.tagNum++,t+""},add:function(t,e){var i=this;t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=i.getTag();i.tagPool[e]=t,t.set("tag",e)}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var i=this;t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.get("tag");delete i.tagPool[e]}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.tagNum=0,this.tagPool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)},getModelByTag:function(t){return this.tagPool[t+""]}}),S.B.Validator.add("isNumber",function(t,e){return e===!1||S._.isNumber(t)},"Should be a number"),S.B.Validator.add("isInteger",function(t,e){return e===!1||S._.isInteger(t)},"Should be an integer");var pad0=function(t){return 10>1*t?"0"+1*t:""+1*t};S.Data=S.B.Model.extend({}),S.Datas=S.B.Collection.extend({model:S.Data}),S.Price=S.B.Model.extend({defaults:{trade_time:"00:00:00"},validation:{trade_date:{format:S.PatternTradeDate},count_down_days:{isInteger:!0},trade_time:{required:!0,format:S.PatternTradeTime}}}),S.Prices=S.B.Collection.extend({model:S.Price}),S.Contract=S.B.Model.extend({getAddedPrices:function(t){var e=[];S._.each(t,function(t){e.push(S._.map(t,function(t){return t.trade_date+" "+t.trade_time}))});var i=S._.sortBy(S._.uniq(S._.flatten(e)),function(t){return new Date(t)}),n=[];S._.each(t,function(t){n.push(S._.object(S._.map(t,function(t){var e=t.trade_date+" "+t.trade_time;return[e,S._.pick(t,"trade_date","trade_time","open","high","low","close","volume")]})))});var s=[];return S._.each(i,function(t){var e=t.split(" ")[0],i=t.split(" ")[1];s.push(S._.reduce(n,function(n,s){var a=s[t];return S._.isUndefined(a)?{trade_date:e,trade_time:i,open:null,high:null,low:null,close:null,volume:null}:S._.isNull(n)?S._.clone(a):S._.isNull(n.open)?n:{trade_date:e,trade_time:i,open:n.open+a.open,high:n.high+a.high,low:n.low+a.low,close:n.close+a.close,volume:n.volume+a.volume}},null))}),s},getCAddedPrices:function(t){var e=[];S._.each(t,function(t){e.push(S._.map(t,function(t){return t.count_down_days+" "+t.trade_time}))});var i=S._.sortBy(S._.uniq(S._.flatten(e)),function(t){var e=1*t.split(" ")[0],i=t.split(" ")[1],n=1*i.split(":")[0],s=1*i.split(":")[1],a=1*i.split(":")[2];return 86400*e+3600*n+60*s+1*a}),n=[];S._.each(t,function(t){n.push(S._.object(S._.map(t,function(t){var e=t.count_down_days+" "+t.trade_time;return[e,S._.pick(t,"count_down_days","trade_time","open","high","low","close","volume")]})))});var s=[];return S._.each(i,function(t){var e=1*t.split(" ")[0],i=t.split(" ")[1];s.push(S._.reduce(n,function(n,s){var a=s[t];return S._.isUndefined(a)?{count_down_days:e,trade_time:i,open:null,high:null,low:null,close:null,volume:null}:S._.isNull(n)?S._.clone(a):S._.isNull(n.open)?n:{count_down_days:e,trade_time:i,open:n.open+a.open,high:n.high+a.high,low:n.low+a.low,close:n.close+a.close,volume:n.volume+a.volume}},null))}),s},loadNative:function(t,e){var i=S._.extend(S._.omit(t,"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end"),e);this.set("contract_info",i);var n=S._.extend(S._.pick(t,"exchange","contract_name","contract_date","contract_type","contract_price","option_type"),e);this.set("price_query",n),this.set("prices",new S.Prices),this.get("prices").url=S.URL_PRICE,this.get("prices").fetch({data:n,async:!1,reset:!0})},loadCloned:function(t,e){this.set("contract_info",t),this.set("prices",new S.Prices(e))},loadAdded:function(t){var e=[],i=[],n=[];S._.each(t,function(t){e.push("("+t.get("contract_info").name.en+")"),i.push("("+t.get("contract_info").name.cht+")"),n.push(t.get("prices").toJSON())});var s={en:e.join(" + "),cht:i.join(" + ")},a=S._.pick(t[0].get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end"),o=S._.extend({name:s,contract_type:S.CT_ADDED,has_trade_date:!0,has_count_down_days:!1},a);this.set("contract_info",o),this.set("prices",new S.Prices(this.getAddedPrices(n)))},loadCAdded:function(t){var e=[],i=[],n=[];S._.each(t,function(t){e.push("("+t.get("contract_info").name.en+")"),i.push("("+t.get("contract_info").name.cht+")"),n.push(t.get("prices").toJSON())});var s={en:e.join(" | "),cht:i.join(" | ")},a=S._.pick(t[0].get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end"),o=S._.extend({name:s,contract_type:S.CT_CADDED,has_trade_date:!1,has_count_down_days:!0},a);this.set("contract_info",o),this.set("prices",new S.Prices(this.getCAddedPrices(n)))}}),S.Contracts=S.Collection2.extend({model:S.Contract}),S.Discussion=S.B.Model.extend({defaults:{contracts:null},initialize:function(){this.set("contracts",new S.Contracts)},_addContract:function(t){this.get("contracts").add(t)},addContract:function(){if(arguments.length<=0)return null;var t=this,e=null,i=arguments[0];switch(i){case S.AC_NATIVE:var n=arguments[1],s=arguments[2];e=new S.Contract,e.loadNative(n,s),this._addContract(e);break;case S.AC_CLONE:var a=arguments[1],o=this.getContract(a);if(!S._.isNull(o)){var n=o.get("contract_info"),r=o.get("prices").toJSON();e=new S.Contract,e.loadCloned(n,r),this._addContract(e)}break;case S.AC_ADD:var c=S._.filter(arguments,function(t,e){return e>0}),d=S._.reduce(c,function(e,i){return e&&!S._.isNull(t.getContract(i))&&t.getContract(i).get("contract_info").has_trade_date===!0},!0);if(d){var l=[];S._.each(c,function(e){l.push(t.getContract(e))}),e=new S.Contract,e.loadAdded(l),this._addContract(e)}break;case S.AC_CADD:var c=S._.filter(arguments,function(t,e){return e>0}),d=S._.reduce(c,function(e,i){return e&&!S._.isNull(t.getContract(i))&&t.getContract(i).get("contract_info").has_count_down_days===!0},!0);if(d){var l=[];S._.each(c,function(e){l.push(t.getContract(e))}),e=new S.Contract,e.loadCAdded(l),this._addContract(e)}}return e},getContract:function(t){var e=this.get("contracts").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e}}),S.Discussions=S.Collection2.extend({model:S.Discussion}),S.DiscussionGroup=S.B.Model.extend({defaults:{discussions:null},initialize:function(){this.set("discussions",new S.Discussions)},_addDiscussion:function(t){this.get("discussions").add(t)},addDiscussion:function(t,e){var i=new S.Discussion;return this._addDiscussion(i),i.addContract(S.AC_NATIVE,t,e),i},getDiscussion:function(t){var e=this.get("discussions").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e},addContracts:function(){if(arguments.length<=0)return null;var t=null,e=arguments,i=arguments[0];switch(i){case S.AC_CLONE:case S.AC_ADD:case S.AC_CADD:t=[],this.get("discussions").each(function(i){var n=i.addContract.apply(i,e);t.push(n)});break;case S.AC_NATIVE:}return t},getContracts:function(t){var e=[];return this.get("discussions").each(function(i){var n=i.getContract(t);e.push(n)}),e}}),S.DiscussionGroups=S.Collection2.extend({model:S.DiscussionGroup}),S.DiscussionGroupGroup=S.B.Model.extend({defaults:{discussion_groups:null},initialize:function(){this.set("discussion_groups",new S.DiscussionGroups)},_addDiscussionGroup:function(t){this.get("discussion_groups").add(t)},addDiscussionGroup:function(t,e){var i=new S.Datas;i.url=S.URL_CONTRACT_LIST,i.fetch({data:{filter:JSON.stringify(t)},async:!1,reset:!0});var n=new S.DiscussionGroup;return this._addDiscussionGroup(n),S._.each(i.toJSON(),function(t){n.addDiscussion(t,e)}),n},getDiscussionGroup:function(t){var e=this.get("discussion_groups").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e}}),S.ContractView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},events:{click:"showContractWindow"},initialize:function(){this.render_init()},render_init:function(){this.$el.tooltip({position:{my:"left+30 top+30"},track:!0,show:{duration:"fast"},hide:{effect:"hide"},content:function(){return $(this).attr("title")}})},showContractWindow:function(){console.log("showContractWindow(): "+this.model.get("contract_info").name.cht)}}),S.DiscussionView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},initialize:function(){this.render_init(),this.listenTo(this.model.get("contracts"),"add",this.addContractView)},render_init:function(){this.$main=this.$el;var t=this.model.get("tag");this.$title=$('<div class="discussion-title lighten" title="">');var e=$('<div class="blocker">');e.append($('<div class="discussion-number lighten" title="'+t+'">'+t+"</div>")),e.append(this.$title),e.append($('<div class="discussion-remove lighten" title="Remove this discussion">X</div>'));var i=$('<div class="blocker">'),n=$('<div class="inliner">'),s=$('<div class="inliner">');this.$contracts=$('<ol class="contracts">'),this.$transactions=$('<ol class="transactions">'),this.$charts=$('<ol class="charts">'),n.append(this.$contracts),n.append(this.$transactions),s.append(this.$charts),i.append(n),i.append(s),this.$main.append(e),this.$main.append(i),$(".lighten").tooltip({position:{my:"left+30 top+30"},track:!0,show:{duration:"fast"},hide:{effect:"hide"},content:function(){return $(this).attr("title")}})},addContractView:function(t){var e=t.get("tag"),i=t.get("contract_info").name.en+" "+t.get("contract_info").tick_length,n=new S.ContractView({el:$('<li class="contract lighten" title="'+i+'">'+e+"</li>"),model:t});this.$contracts.append(n.$el),"0"==e&&(this.$title.html(i),this.$title.attr("title",i))}}),S.DiscussionGroupView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},initialize:function(){this.$main=this.$el,this.$main.sortable({handle:".discussion-title"}),this.listenTo(this.model.get("discussions"),"add",this.addDiscussionView)},addDiscussionView:function(t){var e=this.model.get("tag"),i=t.get("tag"),n=new S.DiscussionView({el:$('<li id="dg'+e+"-d"+i+'" class="discussion">'),model:t});this.$main.append(n.$el)}}),S.DiscussionGroupGroupView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},initialize:function(){this.render_init(),this.listenTo(this.model.get("discussion_groups"),"add",this.addDiscussionGroupView)},render_init:function(){var t=this;this.$tabs=$('<ul id="tabs">'),this.$el.append(this.$tabs),this.$main=this.$el.tabs(),this.$main.find(".discussion-group").css("padding","5px"),this.$main.find(".ui-tabs-nav").sortable({axis:"x",stop:function(){t.$main.tabs("refresh")}})},addDiscussionGroupView:function(t){var e=t.get("tag");this.$tabs.append($('<li><a href="#dg'+e+'">Discussion Group '+e+'</a><span class="ui-icon ui-icon-close" role="presentation">Remove Tab</span></li>'));var i=new S.DiscussionGroupView({el:$('<ol id="dg'+e+'" class="discussion-group">'),model:t});this.$main.append(i.$el),this.$main.tabs("refresh"),this.$main.tabs("option","active",-1)}}),S.init_layout=function(){var pstyle="margin: 5px; padding: 5px; font-family: Verdana,Arial,sans-serif; font-size: 11px; border: 1px solid #a6c9e2; background: #fcfdfd; color: #222222; border-radius: 5px;";$("#sfo-layout").w2layout({name:"sfo-layout",padding:1,resizer:3,panels:[{type:"top",minSize:450,size:"70%",resizable:!0,style:pstyle},{type:"main",minSize:150,size:"100%",resizable:!0,style:pstyle}]}),S.layout=S.w2ui["sfo-layout"],S.main_frame=S.$(S.layout.el("top")),S.shell_frame=S.$(S.layout.el("main"));var main_div=$('<div class="sfo-main">');S.main_frame.append(main_div),S.discussion_group_group_view=new S.DiscussionGroupGroupView({el:main_div,model:S.discussion_group_group});var shell_div=$('<div class="sfo-shell">');S.shell_frame.append(shell_div);var shell_controller=shell_div.console({promptLabel:"SFO> ",commandHandle:function(line){try{var ret=eval(line);return"undefined"!=typeof ret?ret.toString():!0}catch(err){return[{msg:err.toString(),className:"jquery-console-message-error"}]}},autofocus:!0,animateScroll:!0,promptHistory:!0,welcomeMessage:"Enter some JavaScript expressions to evaluate."})},S.init=function(){try{S.discussion_group_group=new S.DiscussionGroupGroup,S.init_layout()}catch(t){alert(t)}},this.S=S}();