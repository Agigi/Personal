!function(){function getSecondsFromTradeTime(t){return 3600*t.split(":")[0]+60*t.split(":")[1]+1*t.split(":")[2]}function getTradeDateByDateShift(t,e){var n=new Date(t),i=new Date(1*n+864e5*e),r=i.getFullYear()+"",a=pad0(i.getMonth()+1),o=pad0(i.getDate());return t=r+"-"+a+"-"+o}function getTradeDateTimeByDate(t){if(_.isNull(t))return null;var e=t.getFullYear()+"",n=pad0(t.getMonth()+1),i=pad0(t.getDate()),r=pad0(t.getHours()),a=pad0(t.getMinutes()),o=pad0(t.getSeconds());return e+"-"+n+"-"+i+" "+r+":"+a+":"+o}var S={version:"0.0.25"};S.$=this.jQuery||this.Zepto||this.ender||this.$,S._=this._,S.B=this.Backbone,S.w2ui=this.w2ui;var pad0=function(t){return 10>1*t?"0"+1*t:""+1*t};S.URL_CONTRACT_LIST="/contract_list",S.URL_PRICE="/price",S.CT_STOCK="STOCK",S.CT_FUTURE="FUTURE",S.CT_OPTION="OPTION",S.CT_INDICATOR="INDICATOR",S.CT_MERGED="MERGED",S.OT_CALL="C",S.OT_PUT="P",S.PT_OPEN="OPEN",S.PT_HIGH="HIGH",S.PT_LOW="LOW",S.PT_CLOSE="CLOSE",S.PatternRegExpGeneric=/^.+$/,S.PatternContractType=/^(STOCK|FUTURE|OPTION)$/,S.PatternOptionType=/^(C|P)$/,S.PatternTickLength=/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D|1W|1N|3N|1Y)$/,S.PatternTradeDate=/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/,S.PatternTradeTime=/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/,S.PatternTradeDay=/^[0-6]$/,S.PatternUnderlyingAssetType=/^(STOCK|FUTURE)$/,S.PatternPriceType=/^(OPEN|HIGH|LOW|CLOSE)$/,S.AC_NATIVE="NATIVE",S.AC_CLONE="CLONE",S.AC_INDICATOR="INDICATOR",S.AC_MERGE="MERGE",S.AC_DATESHIFT="DATESHIFT",S.CT_K_BAR="K_BAR",S.CT_VOLUME="VOLUME",S.CT_LINE="LINE",S.CHART_SPACING=2,S.DefaultRangeButtons={"1S":{type:"minute",count:12,text:"12M"},"15S":{type:"hour",count:3,text:"3H"},"1M":{type:"hour",count:12,text:"12H"},"2M":{type:"day",count:1,text:"1D"},"3M":{type:"hour",count:36,text:"36H"},"5M":{type:"hour",count:60,text:"60H"},"10M":{type:"day",count:5,text:"5D"},"15M":{type:"hour",count:180,text:"180H"},"20M":{type:"day",count:10,text:"10D"},"30M":{type:"day",count:15,text:"15D"},"60M":{type:"month",count:1,text:"1N"},"1D":{type:"year",count:2,text:"2Y"},"1W":{type:"year",count:14,text:"14Y"},"1N":{type:"year",count:60,text:"60Y"},"3N":{type:"year",count:180,text:"180Y"},"1Y":{type:"year",count:720,text:"720Y"}},S._.isInteger=function(t){return S._.isNumber(t)&&Math.floor(t)==t},S.Collection2=S.B.Collection.extend({initialize:function(){this.tagNum=0,this.tagPool=S._.clone({})},getTag:function(){var t=this.tagNum;return this.tagNum++,t+""},getModelByTag:function(t){return this.tagPool[t+""]},add:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=n.getTag();n.tagPool[e]=t,t.set("tag",e)}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.get("tag");delete n.tagPool[e],t.unset("tag")}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){return this.tagNum=0,this.tagPool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)}}),S.B.Validator.add("isNumber",function(t,e){return e===!1||S._.isNumber(t)},"Should be a number"),S.B.Validator.add("isInteger",function(t,e){return e===!1||S._.isInteger(t)},"Should be an integer"),S.indicator_function={},S.indicator_function.MA=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=e-1){for(var r=0,a=-1*(e-1);0>=a;a++)r+=n.get(t,a);i=r/e}return i},S.indicator_function.BIAS=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=e-1){var r=this.MA(t,e);i=100*((n.get(t)-r)/r)}return i},S.indicator_function.EMA=function(t,e){var n=this.getSourcePrice(),i=null,r=n.get(t);if(0==n.index())i=r;else{var a=this.other(-1).get("ema");i=a+2/(1+e)*(r-a)}return i},S.indicator_function.HIGHEST=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=e-1){i=n.get(t);for(var r=-1*(e-1);0>=r;r++)i=i>n.get(t,r)?i:n.get(t,r)}return i},S.indicator_function.LOWEST=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=e-1){i=n.get(t);for(var r=-1*(e-1);0>=r;r++)i=i<n.get(t,r)?i:n.get(t,r)}return i},S.indicator_function.RSV=function(t){var e=this.getSourcePrice(),n=null;if(e.index()>=t-1){var i=this.HIGHEST("high",t),r=this.LOWEST("low",t);n=e.get("volume")>0&&i>r?100*((e.get("close")-r)/(i-r)):e.index()==t-1?0:this.other(-1).get("rsv")}return n},S.indicator_function.KD_K=function(t){var e=this.getSourcePrice(),n=null;if(e.index()>=t-1){var i=this.HIGHEST("high",t),r=this.LOWEST("low",t),a=e.index()==t-1?50:this.other(-1).get("k");if(e.get("volume")>0&&i>r){var o=this.RSV(t);n=2/3*a+1/3*o}else n=a}return n},S.indicator_function.KD_D=function(t){var e=this.getSourcePrice(),n=null;if(e.index()>=t-1){var i=this.HIGHEST("high",t),r=this.LOWEST("low",t),a=e.index()==t-1?50:this.other(-1).get("d");if(e.get("volume")>0&&i>r){var o=this.KD_K(t);n=2/3*a+1/3*o}else n=a}return n},S.indicator_function.MACD_EMA_FAST=function(t){var e=this.getSourcePrice(),n=null,i=(e.get("high")+e.get("low")+2*e.get("close"))/4;if(0==e.index())n=i;else{var r=this.other(-1).get("ema_fast");n=r+2/(1+t)*(i-r)}return n},S.indicator_function.MACD_EMA_SLOW=function(t){var e=this.getSourcePrice(),n=null,i=(e.get("high")+e.get("low")+2*e.get("close"))/4;if(0==e.index())n=i;else{var r=this.other(-1).get("ema_slow");n=r+2/(1+t)*(i-r)}return n},S.indicator_function.MACD_DIF=function(t,e){var n=this.MACD_EMA_FAST(t)-this.MACD_EMA_SLOW(e);return n},S.indicator_function.MACD_DEM=function(t,e,n){var i=this.getSourcePrice(),r=null,a=this.MACD_DIF(t,e);if(0==i.index())r=a;else{var o=this.other(-1).get("dem");r=o+2/(1+n)*(a-o)}return r},S.indicator_function.MACD_OSC=function(t,e,n){var i=this.MACD_DIF(t,e)-this.MACD_DEM(t,e,n);return i},S.indicator_function.STD=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=e-1){for(var r=this.MA(t,e),a=0,o=-1*(e-1);0>=o;o++)a+=Math.pow(n.get(t,o)-r,2);i=Math.sqrt(a/(e-1))}return i},S.indicator_function.BB_UB=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=t-1){var r=this.MA("close",t),a=this.STD("close",t);i=r+a*e}return i},S.indicator_function.BB_MB=function(t){var e=this.getSourcePrice(),n=null;if(e.index()>=t-1){var i=this.MA("close",t);n=i}return n},S.indicator_function.BB_LB=function(t,e){var n=this.getSourcePrice(),i=null;if(n.index()>=t-1){var r=this.MA("close",t),a=this.STD("close",t);i=r-a*e}return i},S.IT_MA="MA",S.getIndicatorName_MA=function(t,e){var n=e.price_type,i=e.length,r={en:"MA("+t.get("contract_info").name.en+", "+n+", "+i+")",cht:"MA("+t.get("contract_info").name.cht+", "+n+", "+i+")"};return r},S.addIndicatorPrice_MA=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.price_type,a=t.length;i.set("ma",function(){return this.MA(r,a)})}},S.IT_BIAS="BIAS",S.getIndicatorName_BIAS=function(t,e){var n=e.price_type,i=e.length,r={en:"BIAS("+t.get("contract_info").name.en+", "+n+", "+i+")",cht:"BIAS("+t.get("contract_info").name.cht+", "+n+", "+i+")"};return r},S.addIndicatorPrice_BIAS=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.price_type,a=t.length;i.set("bias",function(){return this.BIAS(r,a)})}},S.IT_EMA="EMA",S.getIndicatorName_EMA=function(t,e){var n=e.price_type,i=e.length,r={en:"EMA("+t.get("contract_info").name.en+", "+n+", "+i+")",cht:"EMA("+t.get("contract_info").name.cht+", "+n+", "+i+")"};return r},S.addIndicatorPrice_EMA=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.price_type,a=t.length;i.set("ema",function(){return this.EMA(r,a)})}},S.IT_KD="KD",S.getIndicatorName_KD=function(t,e){var n=e.length,i=e.over_sold,r=e.over_bought,a={en:"KD("+t.get("contract_info").name.en+", "+n+", "+i+", "+r+")",cht:"KD("+t.get("contract_info").name.cht+", "+n+", "+i+", "+r+")"};return a},S.addIndicatorPrice_KD=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.length,a=t.over_sold,o=t.over_bought;i.set("over_sold",a),i.set("over_bought",o),i.set("rsv",function(){return this.RSV(r)}),i.set("k",function(){return this.KD_K(r)}),i.set("d",function(){return this.KD_D(r)})}},S.IT_MACD="MACD",S.getIndicatorName_MACD=function(t,e){var n=e.fast,i=e.slow,r=e.length,a={en:"MACD("+t.get("contract_info").name.en+", "+n+", "+i+", "+r+")",cht:"MACD("+t.get("contract_info").name.cht+", "+n+", "+i+", "+r+")"};return a},S.addIndicatorPrice_MACD=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.fast,a=t.slow,o=t.length;i.set("ema_fast",function(){return this.MACD_EMA_FAST(r)}),i.set("ema_slow",function(){return this.MACD_EMA_SLOW(a)}),i.set("dif",function(){return this.MACD_DIF(r,a)}),i.set("dem",function(){return this.MACD_DEM(r,a,o)}),i.set("osc",function(){return this.MACD_OSC(r,a,o)})}},S.IT_BB="BB",S.getIndicatorName_BB=function(t,e){var n=e.length,i=e.band_width,r={en:"BB("+t.get("contract_info").name.en+", "+n+", "+i+")",cht:"BB("+t.get("contract_info").name.cht+", "+n+", "+i+")"};return r},S.addIndicatorPrice_BB=function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last(),r=t.length,a=t.band_width;i.set("upper_band",function(){return this.BB_UB(r,a)}),i.set("middle_band",function(){return this.BB_MB(r)}),i.set("lower_band",function(){return this.BB_LB(r,a)})}},S.getIndicatorName=function(t,e,n){var i="getIndicatorName_"+e;return S[i](t,n)},S.addIndicatorPrice=function(t,e){var n="addIndicatorPrice_"+t;return S[n](e)},S.Data=S.B.Model.extend({}),S.Datas=S.B.Collection.extend({model:S.Data}),S.Price=S.B.Model.extend({defaults:{trade_date:"1970-01-01",trade_time:"00:00:00"},validation:{trade_date:{required:!0,format:S.PatternTradeDate},trade_time:{required:!0,format:S.PatternTradeTime}},hasPrices:function(){return!S._.isUndefined(this.collection)},getPrices:function(){return this.hasPrices()?this.collection:null},index:function(){return this.hasPrices()?this.getPrices().indexOf(this):null},isFinal:function(){return this.hasPrices()?this.index()==this.getPrices().length-1:!1},other:function(t){if(S._.isNumber(t)&&0!=t){if(!this.hasPrices())return null;var e=this.index();return e+=t,0>e||e>this.getPrices().length-1?null:this.getPrices().at(e)}return this},get:function(t,e){if(S._.isNumber(e)&&0!=e){if(!this.hasPrices())return null;var n=this.other(e);return S._.isNull(n)?null:n.get(t)}var i=S.B.Model.prototype.get.call(this,t);return S._.isUndefined(i)?i=null:S._.isFunction(i)&&(i=i.call(this),this.isFinal()||this.set(t,i,{silent:!0})),i},getTradeDateTime:function(){return this.get("trade_date")+" "+this.get("trade_time")},toJSON:function(){var t=this;return S._.object(S._.map(this.keys(),function(e){return[e,t.get(e)]}))},values:function(){return S._.values(this.toJSON())},pairs:function(){return S._.pairs(this.toJSON())},getSourcePrice:function(){if(!this.hasPrices())return null;var t=this.getPrices().getSourcePrices();return t instanceof S.Prices?t.getPriceByTradeDateTime(this.getTradeDateTime()):null}}),S._.extend(S.Price.prototype,S.indicator_function),S.Prices=S.B.Collection.extend({model:S.Price,initialize:function(){this.tradeDateTimePool=S._.clone({})},getPriceByTradeDateTime:function(t){return this.tradeDateTimePool[t]},getSourcePrices:function(){return S._.isUndefined(this.source_prices)?null:this.source_prices},addPrice:function(t){this.add(t.toJSON())},changePrice:function(){this.trigger("change")},clearAllPrices:function(){return this.reset([],{silent:!0})},add:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],t=S._.map(t,function(t){return t instanceof S.Price?t:new S.Price(t)}),S._.each(t,function(t){var e=t.getTradeDateTime();n.tradeDateTimePool[e]=t}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.getTradeDateTime();delete n.tradeDateTimePool[e]}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){return this.tradeDateTimePool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)}}),S.Contract=S.B.Model.extend({getNativeInfo:function(t){var e={exchange:"^"+t.exchange+"$",contract_type:"^"+t.contract_type+"$",contract_name:"^"+t.contract_name+"$"};switch(t.contract_type){case S.CT_STOCK:break;case S.CT_FUTURE:e.contract_date="^"+t.contract_date+"$";break;case S.CT_OPTION:e.contract_date="^"+t.contract_date+"$",e.contract_price_begin=t.contract_price,e.contract_price_end=t.contract_price,e.option_type="^"+t.option_type+"$";break;default:return null}var n=new S.Datas;if(n.url=S.URL_CONTRACT_LIST,n.fetch({data:{filter:JSON.stringify([e])},async:!1,reset:!0}),n.size()<1)return null;var i=S._.extend(n.toJSON()[0],t);return i},getClonedInfo:function(t){return S._.clone(t.get("contract_info"))},getIndicatorInfo:function(t,e,n){var i=S.getIndicatorName(t,e,n),r=S._.pick(t.get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end","trade_date_final","trade_time_final"),a=S._.extend({name:i,contract_type:S.CT_INDICATOR,indicator_type:e,indicator_param:n},r);return a},getMergedInfoArray:function(t,e){return S._.map(t,function(t){var n=t.contract.get("contract_info")[e];return n=S._.isUndefined(n)?null:n})},getMergedInfo:function(t){var e=S._.map(t,function(t){return"("+t.contract.get("contract_info").name.en+")*"+t.factor}),n=S._.map(t,function(t){return"("+t.contract.get("contract_info").name.cht+")*"+t.factor}),i={en:e.join(" + "),cht:n.join(" + ")},r={name:i,contract_type:S.CT_MERGED,tick_length:t[0].contract.get("contract_info").tick_length};r.trade_day_begin=S._.min(this.getMergedInfoArray(t,"trade_day_begin")),r.trade_day_end=S._.max(this.getMergedInfoArray(t,"trade_day_end")),r.trade_date_begin=S._.sortBy(this.getMergedInfoArray(t,"trade_date_begin"),function(t){return 1*new Date(t)})[0],r.trade_date_end=S._.sortBy(this.getMergedInfoArray(t,"trade_date_end"),function(t){return-1*new Date(t)})[0],r.trade_time_begin=S._.sortBy(this.getMergedInfoArray(t,"trade_time_begin"),function(t){return 1*getSecondsFromTradeTime(t)})[0],r.trade_time_end=S._.sortBy(this.getMergedInfoArray(t,"trade_time_end"),function(t){return-1*getSecondsFromTradeTime(t)})[0];var a=S._.uniq(this.getMergedInfoArray(t,"trade_date_final"));1!=a.length||S._.isNull(a[0])||(r.trade_date_final=a[0]);var o=S._.uniq(this.getMergedInfoArray(t,"trade_time_final"));return 1!=o.length||S._.isNull(o[0])||(r.trade_time_final=o[0]),r},getDateShiftInfo:function(t,e){var n=e>=0?"+"+e+"days":e+"days",i={en:"("+t.get("contract_info").name.en+")"+n,cht:"("+t.get("contract_info").name.cht+")"+n},r=S._.clone(t.get("contract_info"));return r.name=i,r.trade_date_begin=getTradeDateByDateShift(r.trade_date_begin,e),r.trade_date_end=getTradeDateByDateShift(r.trade_date_end,e),r.trade_date_final=getTradeDateByDateShift(r.trade_date_final,e),r},addClonedPrice:function(){return function(t){var e=this;e.add(new S.Price({trade_date:t.get("trade_date"),trade_time:t.get("trade_time")}));var n=e.last();S._.each(S._.without(t.keys(),"trade_date","trade_time"),function(e){n.set(e,function(){return t.get(e)})})}},addIndicatorPrice:S.addIndicatorPrice,addMergedPrice:function(t,e){return function(n){var i=this,r=n.getTradeDateTime(),a=i.getPriceByTradeDateTime(r);if(S._.isUndefined(a)){var o=0;if(0==n.index())i.each(function(t,e){new Date(r)>new Date(t.getTradeDateTime())&&(o=e+1)});else{var c=i.getPriceByTradeDateTime(n.other(-1).getTradeDateTime());o=c.index()+1}i.add(new S.Price({trade_date:n.get("trade_date"),trade_time:n.get("trade_time")}),{at:o}),a=i.at(o),S._.each(t,function(t,n){a.set(t,function(){return S._.reduce(e,function(t,e){var i=e.prices.getPriceByTradeDateTime(r);if(S._.isUndefined(i))return null;var a=i.get(e.fields[n]);return S._.isNull(t)||S._.isNull(a)?null:t+a*e.factor},0)})})}}},addDateShiftPrice:function(t){return function(e){var n=this;n.add(new S.Price({trade_date:e.get("trade_date"),trade_time:e.get("trade_time")}));var i=n.last();S._.each(S._.without(e.keys(),"trade_date","trade_time"),function(t){i.set(t,function(){return e.get(t)})}),i.set("trade_date",getTradeDateByDateShift(i.get("trade_date"),t))}},loadNative:function(t){var e=this.getNativeInfo(t);if(S._.isNull(e))return!1;var n=new S.Prices;return n.url=S.URL_PRICE,n.fetch({data:t,async:!1,reset:!0}),this.set("contract_info",e),this.set("prices",n),!0},loadCloned:function(t){var e=this.getClonedInfo(t),n=new S.Prices;n.addPrice=this.addClonedPrice(),t.get("prices").each(function(t){n.addPrice(t)}),n.listenTo(t.get("prices"),"add",n.addPrice),n.listenTo(t.get("prices"),"change",n.changePrice),this.set("contract_info",e),this.set("prices",n)},loadIndicator:function(t,e,n){var i=this.getIndicatorInfo(t,e,n),r=new S.Prices;r.source_prices=t.get("prices"),r.addPrice=this.addIndicatorPrice(e,n),t.get("prices").each(function(t){r.addPrice(t)}),r.listenTo(t.get("prices"),"add",r.addPrice),r.listenTo(t.get("prices"),"change",r.changePrice),this.set("contract_info",i),this.set("prices",r)},loadMerged:function(t,e){var n=this.getMergedInfo(e),i=new S.Prices,r=S._.map(e,function(t){return{prices:t.contract.get("prices"),factor:t.factor,fields:t.fields}});i.addPrice=this.addMergedPrice(t,r),S._.each(r,function(t){t.prices.each(function(t){i.addPrice(t)}),i.listenTo(t.prices,"add",i.addPrice),i.listenTo(t.prices,"change",i.changePrice)}),this.set("contract_info",n),this.set("prices",i)},loadDateShift:function(t,e){var n=t.get("contract_info").trade_date_final,i=e.get("contract_info").trade_date_final,r=(1*new Date(i)-1*new Date(n))/864e5,a=this.getDateShiftInfo(t,r),o=new S.Prices;o.addPrice=this.addDateShiftPrice(r),t.get("prices").each(function(t){o.addPrice(t)}),o.listenTo(t.get("prices"),"add",o.addPrice),o.listenTo(t.get("prices"),"change",o.changePrice),this.set("contract_info",a),this.set("prices",o)}}),S.Contracts=S.Collection2.extend({model:S.Contract}),S.View=S.B.Model.extend({defaults:{view:null}}),S.Views=S.Collection2.extend({model:S.View}),S.Discussion=S.B.Model.extend({defaults:{contracts:null,charts:null},initialize:function(){this.set("contracts",new S.Contracts),this.set("charts",new S.Views)},_addContract:function(t){this.get("contracts").add(t)},addContract:function(){if(arguments.length<=0)return null;var t=this,e=null,n=arguments[0];switch(n){case S.AC_NATIVE:var i=arguments[1];e=new S.Contract,e.loadNative(i)&&this._addContract(e);break;case S.AC_CLONE:var r=arguments[1],a=this.getContract(r);S._.isNull(a)||(e=new S.Contract,e.loadCloned(a),this._addContract(e));break;case S.AC_INDICATOR:var r=arguments[1],o=arguments[2],c=arguments[3],a=this.getContract(r);S._.isNull(a)||(e=new S.Contract,e.loadIndicator(a,o,c),this._addContract(e));break;case S.AC_MERGE:var s=arguments[1],d=arguments[2];if(!S._.isArray(s)||!S._.isArray(d))break;var u=S._.reduce(d,function(e,n){var i=n.tag;return e&&!S._.isUndefined(i)&&!S._.isNull(t.getContract(i))},!0);if(u){var l=S._.map(d,function(e){return{contract:t.getContract(e.tag),factor:S._.isNumber(e.factor)?e.factor:1,fields:S._.isArray(e.fields)?e.fields:s}}),h=S._.uniq(S._.map(l,function(t){return t.contract.get("contract_info").tick_length}));1==h.length&&(e=new S.Contract,e.loadMerged(s,l),this._addContract(e))}break;case S.AC_DATESHIFT:var _=arguments[1],g=arguments[2],f=this.getContract(_),m=this.getContract(g);S._.isNull(f)||S._.isNull(m)||S._.isUndefined(f.get("contract_info").trade_date_final)||S._.isUndefined(m.get("contract_info").trade_date_final)||/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D)$/.test(f.get("contract_info").tick_length)&&(e=new S.Contract,e.loadDateShift(f,m),this._addContract(e))}return e},getContract:function(t){var e=this.get("contracts").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e},_addChart:function(t){this.get("charts").add(t)},addChart:function(t){var e=this;if(!S._.isArray(t))return null;if(t.length<=0||t.length>6)return null;var n=S._.reduce(t,function(t,n){if(!t||!S._.isArray(n))return!1;var i=S._.reduce(n,function(t,n){var i=e.getContract(n.tag);return t&&!S._.isNull(i)&&!S._.isUndefined(n.type)},!0);return t&&i},!0);if(!n)return null;var i=S._.map(t,function(t){return S._.map(t,function(t){return S._.omit(S._.extend({contract:e.getContract(t.tag)},t),"tag")})}),r=new S.View({chart_params:i});return this._addChart(r),r},getChart:function(t){var e=this.get("charts").getModelByTag(t);return S._.isUndefined(e)?null:e},removeChart:function(t){var e=this.getChart(t);S._.isNull(e)||this.get("charts").remove(e)}}),S.ContractView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.model)},tagName:"li",className:"contract lighten",events:{click:"showContractWindow"},initialize:function(){this.render()},render:function(){var t=this.model.get("tag"),e=this.model.get("contract_info").name.en+" "+this.model.get("contract_info").tick_length;this.$el.html(t),this.$el.attr("title",e),this.$el.tooltip({position:{my:"left+30 top+30"},track:!0,show:{duration:"fast"},hide:{effect:"hide"},content:function(){return $(this).attr("title")}})},showContractWindow:function(){console.log("showContractWindow(): "+this.model.get("contract_info").name.cht)}}),S.ChartView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.model)},tagName:"div",className:"chart",initialize:function(){this.render();var t=this;S._.each(this.ssc_arr,function(e){t.listenTo(e.contract.get("prices"),"add",t.redraw),t.listenTo(e.contract.get("prices"),"change",t.redraw)})},render:function(){this.$el.attr("id","chart"+this.model.get("tag")),this.$chart=$('<div class="chart_view">'),this.$slider=$('<div class="chart_slider">'),this.$el.append(this.$chart),this.$el.append(this.$slider);var t=this,e=[];this.ssc_arr=[];var n=this.model.get("chart_params");S._.each(n,function(n,i){S._.each(n,function(n){var r=n.contract,a={name:r.get("contract_info").name.en+" "+r.get("contract_info").tick_length,yAxis:i,dataGrouping:{enabled:!1}};switch(n.type){case S.CT_K_BAR:n=S._.defaults(n,{open:"open",high:"high",low:"low",close:"close",color:"#9aba58",upColor:"red"}),a.type="candlestick",a.color=n.color,a.upColor=n.upColor,a.data=r.get("prices").map(function(t){return[1*new Date(t.getTradeDateTime()),t.get(n.open),t.get(n.high),t.get(n.low),t.get(n.close)]});break;case S.CT_VOLUME:n=S._.defaults(n,{volume:"volume"}),a.type="column",a.data=r.get("prices").map(function(t){return[1*new Date(t.getTradeDateTime()),t.get(n.volume)]});break;case S.CT_LINE:n=S._.defaults(n,{line:"line"}),a.type="line",a.data=r.get("prices").map(function(t){return[1*new Date(t.getTradeDateTime()),t.get(n.line)]})}e.push(a),t.ssc_arr.push(n)})});var i=S._.map(n,function(t,e){var i=Math.round(1e4*(e/n.length))/100;i=0==i?0:i+S.CHART_SPACING/2;var r=Math.round(1e4*((e+1)/n.length))/100;r=100==r?100:r-S.CHART_SPACING/2;var a=r-i;return{labels:{align:"left"},maxPadding:0,minPadding:0,top:i+"%",height:a+"%",offset:0}}),r=n[0][0].contract.get("contract_info").tick_length,a=S.DefaultRangeButtons[r],o={tooltip:{animation:!1,useHTML:!0,xDateFormat:"<b>%Y-%m-%d %H:%M:%S</b>"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%Y-%m-%d<br/>%H:%M:%S",minute:"%Y-%m-%d<br/>%H:%M",hour:"%Y-%m-%d<br/>%H:%M",day:"%Y-%m-%d",week:"%Y-%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:i,plotOptions:{series:{animation:!1},candlestick:{animation:!1,tooltip:{pointFormat:'<b><span style="color:{series.color}">{series.name}:</span> {point.open} <span style="color:{series.color}">{point.high} {point.low}</span> {point.close}</b><br/>'}},column:{animation:!1,tooltip:{pointFormat:'<b><span style="color:{series.color}">{series.name}:</span> {point.y}</b><br/>'}},line:{animation:!1,tooltip:{pointFormat:'<b><span style="color:{series.color}">{series.name}:</span> {point.y}</b><br/>'},lineWidth:1}},rangeSelector:{allButtonsEnabled:!0,buttons:[a,{type:"all",text:"All"}],selected:0},series:e,chart:{animation:!1,events:{load:function(){setTimeout(function(){S.$(window).trigger("resize"),setTimeout(function(){S.$(window).trigger("resize")},100)},100)}}}};if(this.$chart.highcharts("StockChart",o),n.length>1){var c=S._.without(S._.map(n,function(t,e){return Math.round(1e4*(e/n.length))/100}),0),s={values:c,gap:10,left:10,right:90,step:.01,orientation:"vertical",change:function(e,n){var i=S._.map([100].concat(S._.clone(n.values).reverse()),function(t){return 100-t}),r=S._.map(i,function(t,e){var n=0==e?0:t+S.CHART_SPACING/2,r=e==i.length-1?100:i[e+1]-S.CHART_SPACING/2,a=r-n;return{top:n+"%",height:a+"%"}});S._.each(r,function(e,n){t.$chart.highcharts().yAxis[n].update(e,!1)}),t.$chart.highcharts().redraw()}};this.$slider.limitslider(s)}},redraw:function(){var t=this;S._.each(this.ssc_arr,function(e,n){var i=t.$chart.highcharts().series[n],r=S._.last(i.data),a=getTradeDateTimeByDate(new Date(r.x)),o=e.contract.get("prices"),c=o.getPriceByTradeDateTime(a);if(!S._.isUndefined(c)){switch(i.type){case"candlestick":r.update([1*new Date(c.getTradeDateTime()),c.get(e.open),c.get(e.high),c.get(e.low),c.get(e.close)],!1,!1);break;case"column":r.update([1*new Date(c.getTradeDateTime()),c.get(e.volume)],!1,!1);break;case"line":r.update([1*new Date(c.getTradeDateTime()),c.get(e.line)],!1,!1)}for(var s=c.index(),d=o.last().index(),u=s+1;d>=u;u++){var l=o.at(u);switch(i.type){case"candlestick":i.addPoint([1*new Date(l.getTradeDateTime()),l.get(e.open),l.get(e.high),l.get(e.low),l.get(e.close)],!1,!1,!1);break;case"column":i.addPoint([1*new Date(l.getTradeDateTime()),l.get(e.volume)],!1,!1,!1);break;case"line":i.addPoint([1*new Date(l.getTradeDateTime()),l.get(e.line)],!1,!1,!1)}}}}),this.$chart.highcharts().redraw()}}),S.DiscussionView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.model)},tagName:"div",className:"sfo-main",initialize:function(){this.render(),this.listenTo(this.model.get("contracts"),"add",this.addContractView),this.listenTo(this.model.get("charts"),"add",this.addChartView),this.listenTo(this.model.get("charts"),"remove",this.removeChartView)},render:function(){var t=this;this.$main=this.$el;var e=$('<div class="inliner">');this.$charts=$('<div class="charts" id="charts">'),this.$contracts=$('<ol class="contracts">'),this.$transactions=$('<ol class="transactions">'),e.append(this.$contracts),e.append(this.$transactions),this.$main.append(e),this.$main.append(this.$charts),this.$tabs=$('<ul id="tabs">'),this.$charts.append(this.$tabs),this.$charts.tabs(),this.$charts.find(".chart").css("padding","0px"),this.$charts.find(".ui-tabs-nav").sortable({axis:"x",stop:function(){t.$charts.tabs("refresh")}}),this.$charts.delegate("span.ui-icon-close","click",function(){var e=1*$(this).closest("li").find("a").attr("tag");t.model.removeChart(e)}),this.$charts.delegate("li.ui-corner-top","mousedown",function(e){if(2===e.which){var n=1*$(this).find("a").attr("tag");t.model.removeChart(n)}})},addContractView:function(t){var e=new S.ContractView({model:t});this.$contracts.append(e.$el)},addChartView:function(t){var e=t.get("tag"),n=$('<li><a href="#chart'+e+'" tag="'+e+'">Chart '+e+'</a><span class="ui-icon ui-icon-close" role="presentation">Remove Tab</span></li>');this.$tabs.append(n),t.set("$tab",n);var i=new S.ChartView({model:t});this.$charts.append(i.$el),this.$charts.tabs("refresh"),this.$charts.tabs("option","active",-1),t.set("view",i)},removeChartView:function(t){var e=t.get("view");e.remove();var n=t.get("$tab");n.remove(),this.$charts.tabs("refresh")}}),S.init_layout=function(){var pstyle="margin: 5px; padding: 5px; font-family: Verdana,Arial,sans-serif; font-size: 11px; border: 1px solid #a6c9e2; background: #fcfdfd; color: #222222; border-radius: 5px;";$("#sfo-layout").w2layout({name:"sfo-layout",padding:1,resizer:3,panels:[{type:"top",minSize:450,size:"75%",resizable:!0,style:pstyle},{type:"main",minSize:150,size:"100%",resizable:!0,style:pstyle}],onResizing:function(){setTimeout(function(){S.$(window).trigger("resize")},100)}}),S.layout=S.w2ui["sfo-layout"],S.main_frame=S.$(S.layout.el("top")),S.shell_frame=S.$(S.layout.el("main")),S.discussion_view=new S.DiscussionView({model:S.discussion});var main_div=S.discussion_view.$el;S.main_frame.append(main_div);var shell_div=$('<div class="sfo-shell">');S.shell_frame.append(shell_div);var shell_controller=shell_div.console({promptLabel:"SFO> ",commandHandle:function(line){try{var ret=eval(line);return"undefined"!=typeof ret?ret.toString():!0}catch(err){return[{msg:err.toString(),className:"jquery-console-message-error"}]}},autofocus:!0,animateScroll:!0,promptHistory:!0,welcomeMessage:"Enter some JavaScript expressions to evaluate."})},S.init=function(){try{S.discussion=new S.Discussion,S.init_layout()}catch(t){alert(t)}},this.S=S}();