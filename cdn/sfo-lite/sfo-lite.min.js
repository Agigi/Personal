!function(){function getSecondsFromTradeTime(t){return 3600*t.split(":")[0]+60*t.split(":")[1]+1*t.split(":")[2]}function getTradeDateByDateShift(t,e){var n=new Date(t),a=new Date(1*n+864e5*e),r=a.getFullYear()+"",i=pad0(a.getMonth()+1),o=pad0(a.getDate());return t=r+"-"+i+"-"+o}var S={version:"0.0.13"};S.$=this.jQuery||this.Zepto||this.ender||this.$,S._=this._,S.B=this.Backbone,S.w2ui=this.w2ui;var pad0=function(t){return 10>1*t?"0"+1*t:""+1*t};S.URL_CONTRACT_LIST="/contract_list",S.URL_PRICE="/price",S.CT_STOCK="STOCK",S.CT_FUTURE="FUTURE",S.CT_OPTION="OPTION",S.CT_INDICATOR="INDICATOR",S.CT_MERGED="MERGED",S.OT_CALL="C",S.OT_PUT="P",S.PT_OPEN="OPEN",S.PT_HIGH="HIGH",S.PT_LOW="LOW",S.PT_CLOSE="CLOSE",S.PatternRegExpGeneric=/^.+$/,S.PatternContractType=/^(STOCK|FUTURE|OPTION)$/,S.PatternOptionType=/^(C|P)$/,S.PatternTickLength=/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D|1W|1N|3N|1Y)$/,S.PatternTradeDate=/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/,S.PatternTradeTime=/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/,S.PatternTradeDay=/^[0-6]$/,S.PatternUnderlyingAssetType=/^(STOCK|FUTURE)$/,S.PatternPriceType=/^(OPEN|HIGH|LOW|CLOSE)$/,S.AC_NATIVE="NATIVE",S.AC_CLONE="CLONE",S.AC_INDICATOR="INDICATOR",S.AC_MERGE="MERGE",S.AC_DATESHIFT="DATESHIFT",S._.isInteger=function(t){return S._.isNumber(t)&&Math.floor(t)==t},S.Collection2=S.B.Collection.extend({initialize:function(){this.tagNum=0,this.tagPool=S._.clone({})},getTag:function(){var t=this.tagNum;return this.tagNum++,t+""},getModelByTag:function(t){return this.tagPool[t+""]},add:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=n.getTag();n.tagPool[e]=t,t.set("tag",e)}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.get("tag");delete n.tagPool[e],t.unset("tag")}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){return this.tagNum=0,this.tagPool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)}}),S.B.Validator.add("isNumber",function(t,e){return e===!1||S._.isNumber(t)},"Should be a number"),S.B.Validator.add("isInteger",function(t,e){return e===!1||S._.isInteger(t)},"Should be an integer"),S.IT_MA="MA",S.getIndicatorName_MA=function(t,e){var n=e.price_type,a=e.length,r={en:"MA("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"MA("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_MA=function(t,e){var n=e.price_type,a=e.length,r=t.get("prices").map(function(t,e){var r={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),ma:null};if(e>=a-1){for(var i=0,o=-1*(a-1);0>=o;o++)i+=t.get(n,o);r.ma=i/a}return r});return r},S.IT_EMA="EMA",S.getIndicatorName_EMA=function(t,e){var n=e.price_type,a=e.length,r={en:"EMA("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"EMA("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_EMA=function(t,e){var n=e.price_type,a=e.length,r=0,i=t.get("prices").map(function(t,e){var i={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),ema:null},o=t.get(n);return 0==e?r=o:r+=2/(1+a)*(o-r),i.ema=r,i});return i},S.IT_KD="KD",S.getIndicatorName_KD=function(t,e){var n=e.length,a=e.over_sold,r=e.over_bought,i={en:"KD("+t.get("contract_info").name.en+", "+n+", "+a+", "+r+")",cht:"KD("+t.get("contract_info").name.cht+", "+n+", "+a+", "+r+")"};return i},S.getIndicatorPrices_KD=function(t,e){var n=e.length,a=e.over_sold,r=e.over_bought,i=0,o=50,c=50,d=t.get("prices").map(function(t,e){var d={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),over_sold:a,over_bought:r,rsv:null,k:null,d:null};if(e>=n-1){for(var s=t.get("high"),_=t.get("low"),l=-1*(n-1);0>=l;l++)s=s>t.get("high",l)?s:t.get("high",l),_=_<t.get("low",l)?_:t.get("low",l);i=100*((t.get("close")-_)/(s-_)),o=2/3*o+1/3*i,c=2/3*c+1/3*o,d.rsv=i,d.k=o,d.d=c}return d});return d},S.IT_MACD="MACD",S.getIndicatorName_MACD=function(t,e){var n=e.fast,a=e.slow,r=e.length,i={en:"MACD("+t.get("contract_info").name.en+", "+n+", "+a+", "+r+")",cht:"MACD("+t.get("contract_info").name.cht+", "+n+", "+a+", "+r+")"};return i},S.getIndicatorPrices_MACD=function(t,e){var n=e.fast,a=e.slow,r=e.length,i=0,o=0,c=0,d=0,s=0,_=t.get("prices").map(function(t,e){var _={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),dif:null,dem:null,osc:null},l=(t.get("high")+t.get("low")+2*t.get("close"))/4;return 0==e?(i=l,o=l,c=i-o,d=c):(i+=2/(1+n)*(l-i),o+=2/(1+a)*(l-o),c=i-o,d+=2/(1+r)*(c-d)),s=c-d,_.dif=c,_.dem=d,_.osc=s,_});return _},S.IT_BIAS="BIAS",S.getIndicatorName_BIAS=function(t,e){var n=e.price_type,a=e.length,r={en:"BIAS("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"BIAS("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_BIAS=function(t,e){var n=e.price_type,a=e.length,r=t.get("prices").map(function(t,e){var r={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),bias:null};if(e>=a-1){for(var i=0,o=-1*(a-1);0>=o;o++)i+=t.get(n,o);var c=i/a;r.bias=100*((t.get(n)-c)/c)}return r});return r},S.IT_BB="BB",S.getIndicatorName_BB=function(t,e){var n=e.length,a=e.band_width,r={en:"BB("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"BB("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_BB=function(t,e){var n=e.length,a=e.band_width,r=t.get("prices").map(function(t,e){var r={trade_date:t.get("trade_date"),trade_time:t.get("trade_time"),upper_band:null,middle_band:null,lower_band:null};if(e>=n-1){for(var i=0,o=-1*(n-1);0>=o;o++)i+=t.get("close",o);for(var c=i/n,i=0,o=-1*(n-1);0>=o;o++)i+=(t.get("close",o)-c)*(t.get("close",o)-c);var d=Math.sqrt(i/(n-1));r.upper_band=c+d*a,r.middle_band=c,r.lower_band=c-d*a}return r});return r},S.getIndicatorName=function(t,e,n){var a="getIndicatorName_"+e;return S[a](t,n)},S.getIndicatorPrices=function(t,e,n){var a="getIndicatorPrices_"+e;return S[a](t,n)},S.Data=S.B.Model.extend({}),S.Datas=S.B.Collection.extend({model:S.Data}),S.Price=S.B.Model.extend({defaults:{trade_date:"1970-01-01",trade_time:"00:00:00"},validation:{trade_date:{required:!0,format:S.PatternTradeDate},trade_time:{required:!0,format:S.PatternTradeTime}},get:function(t,e){if(S._.isNumber(e)&&0!=e){if(S._.isUndefined(this.collection))return null;var n=this.collection.indexOf(this);return n+=e,0>n||n>this.collection.length-1?null:this.collection.at(n).get(t)}var a=S.B.Model.prototype.get.call(this,t);return a=S._.isUndefined(a)?null:a}}),S.Prices=S.B.Collection.extend({model:S.Price,initialize:function(){this.tradeDateTimePool=S._.clone({})},getPriceByTradeDateTime:function(t){return this.tradeDateTimePool[t]},add:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],t=S._.map(t,function(t){return t instanceof S.Price?t:new S.Price(t)}),S._.each(t,function(t){var e=t.get("trade_date")+" "+t.get("trade_time");n.tradeDateTimePool[e]=t}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var n=this;return t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.get("trade_date")+" "+t.get("trade_time");delete n.tradeDateTimePool[e]}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){return this.tradeDateTimePool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)},getTradeDateTimeArray:function(){var t=this.map(function(t){return t.get("trade_date")+" "+t.get("trade_time")});return t}}),S.Contract=S.B.Model.extend({getMergedInfoArray:function(t,e){return S._.map(t,function(t){var n=t.contract.get("contract_info")[e];return n=S._.isUndefined(n)?null:n})},getMergedPrices:function(t,e){var n=S._.map(e,function(t){return t.prices.getTradeDateTimeArray()}),a=S._.sortBy(S._.uniq(S._.flatten(n)),function(t){return 1*new Date(t)}),r=new S.Prices;return S._.each(a,function(n){var a=n.split(" ")[0],i=n.split(" ")[1],o=S._.reduce(e,function(e,r){var o=r.prices.getPriceByTradeDateTime(n);if(S._.isUndefined(o))return new S.Price(S._.extend({trade_date:a,trade_time:i},S._.object(S._.map(t,function(t){return[t,null]}))));S._.isNull(e)&&(e=new S.Price(S._.extend({trade_date:a,trade_time:i},S._.object(S._.map(t,function(t){return[t,0]})))));for(var c=0;c<t.length;c++){var d=e.get(t[c]),s=o.get(r.fields[c]);S._.isNull(d)||S._.isNull(s)?e.set(t[c],null):e.set(t[c],d+s*r.factor)}return e},null);r.add(o)}),r},loadNative:function(t){var e={exchange:"^"+t.exchange+"$",contract_type:"^"+t.contract_type+"$",contract_name:"^"+t.contract_name+"$"};switch(t.contract_type){case S.CT_STOCK:break;case S.CT_FUTURE:e.contract_date="^"+t.contract_date+"$";break;case S.CT_OPTION:e.contract_date="^"+t.contract_date+"$",e.contract_price_begin=t.contract_price,e.contract_price_end=t.contract_price,e.option_type="^"+t.option_type+"$";break;default:return!1}var n=new S.Datas;if(n.url=S.URL_CONTRACT_LIST,n.fetch({data:{filter:JSON.stringify([e])},async:!1,reset:!0}),n.size()<1)return!1;var a=S._.extend(n.toJSON()[0],t);return this.set("contract_info",a),this.set("prices",new S.Prices),this.get("prices").url=S.URL_PRICE,this.get("prices").fetch({data:t,async:!1,reset:!0}),!0},loadCloned:function(t){var e=S._.clone(t.get("contract_info")),n=new S.Prices;t.get("prices").each(function(t){var e=new S.Price(t.toJSON());n.add(e)}),this.set("contract_info",e),this.set("prices",n)},loadIndicator:function(t,e,n){var a=S.getIndicatorName(t,e,n),r=S._.pick(t.get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end","trade_date_final","trade_time_final"),i=S._.extend({name:a,contract_type:S.CT_INDICATOR,indicator_type:e},r);this.set("contract_info",i),this.set("prices",new S.Prices(S.getIndicatorPrices(t,e,n)))},loadMerged:function(t,e){var n=[],a=[],r=[];S._.each(e,function(t){var e=t.contract,i=t.factor;n.push("("+e.get("contract_info").name.en+")*"+i),a.push("("+e.get("contract_info").name.cht+")*"+i),r.push({prices:e.get("prices"),factor:i,fields:t.fields})});var i={en:n.join(" + "),cht:a.join(" + ")},o={name:i,contract_type:S.CT_MERGED,tick_length:e[0].contract.get("contract_info").tick_length};o.trade_day_begin=S._.min(this.getMergedInfoArray(e,"trade_day_begin")),o.trade_day_end=S._.max(this.getMergedInfoArray(e,"trade_day_end")),o.trade_date_begin=S._.sortBy(this.getMergedInfoArray(e,"trade_date_begin"),function(t){return 1*new Date(t)})[0],o.trade_date_end=S._.sortBy(this.getMergedInfoArray(e,"trade_date_end"),function(t){return-1*new Date(t)})[0],o.trade_time_begin=S._.sortBy(this.getMergedInfoArray(e,"trade_time_begin"),function(t){return 1*getSecondsFromTradeTime(t)})[0],o.trade_time_end=S._.sortBy(this.getMergedInfoArray(e,"trade_time_end"),function(t){return-1*getSecondsFromTradeTime(t)})[0];var c=S._.uniq(this.getMergedInfoArray(e,"trade_date_final"));1!=c.length||S._.isNull(c[0])||(o.trade_date_final=c[0]);var d=S._.uniq(this.getMergedInfoArray(e,"trade_time_final"));1!=d.length||S._.isNull(d[0])||(o.trade_time_final=d[0]),this.set("contract_info",o),this.set("prices",this.getMergedPrices(t,r))},loadDateShift:function(t,e){var n=t.get("contract_info").trade_date_final,a=e.get("contract_info").trade_date_final,r=(1*new Date(a)-1*new Date(n))/864e5,i=r>=0?"+"+r+"days":r+"days",o={en:"("+t.get("contract_info").name.en+")"+i,cht:"("+t.get("contract_info").name.cht+")"+i},c=S._.clone(t.get("contract_info"));c.name=o,c.trade_date_begin=getTradeDateByDateShift(c.trade_date_begin,r),c.trade_date_end=getTradeDateByDateShift(c.trade_date_end,r),c.trade_date_final=getTradeDateByDateShift(c.trade_date_final,r);var d=new S.Prices;t.get("prices").each(function(t){var e=new S.Price(t.toJSON());e.set("trade_date",getTradeDateByDateShift(e.get("trade_date"),r)),d.add(e)}),this.set("contract_info",c),this.set("prices",d)}}),S.Contracts=S.Collection2.extend({model:S.Contract}),S.Discussion=S.B.Model.extend({defaults:{contracts:null},initialize:function(){this.set("contracts",new S.Contracts)},_addContract:function(t){this.get("contracts").add(t)},addContract:function(){if(arguments.length<=0)return null;var t=this,e=null,n=arguments[0];switch(n){case S.AC_NATIVE:var a=arguments[1];e=new S.Contract,e.loadNative(a)&&this._addContract(e);break;case S.AC_CLONE:var r=arguments[1],i=this.getContract(r);S._.isNull(i)||(e=new S.Contract,e.loadCloned(i),this._addContract(e));break;case S.AC_INDICATOR:var r=arguments[1],o=arguments[2],c=arguments[3],i=this.getContract(r);S._.isNull(i)||(e=new S.Contract,e.loadIndicator(i,o,c),this._addContract(e));break;case S.AC_MERGE:var d=arguments[1],s=arguments[2];if(!S._.isArray(d)||!S._.isArray(s))break;var _=S._.reduce(s,function(e,n){var a=n.tag;return e&&!S._.isUndefined(a)&&!S._.isNull(t.getContract(a))},!0);if(_){var l=S._.map(s,function(e){return{contract:t.getContract(e.tag),factor:S._.isNumber(e.factor)?e.factor:1,fields:S._.isArray(e.fields)?e.fields:d}}),u=S._.uniq(S._.map(l,function(t){return t.contract.get("contract_info").tick_length}));1==u.length&&(e=new S.Contract,e.loadMerged(d,l),this._addContract(e))}break;case S.AC_DATESHIFT:var g=arguments[1],f=arguments[2],h=this.getContract(g),m=this.getContract(f);S._.isNull(h)||S._.isNull(m)||S._.isUndefined(h.get("contract_info").trade_date_final)||S._.isUndefined(m.get("contract_info").trade_date_final)||/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D)$/.test(h.get("contract_info").tick_length)&&(e=new S.Contract,e.loadDateShift(h,m),this._addContract(e))}return e},getContract:function(t){var e=this.get("contracts").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e}}),S.ContractView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.model)},tagName:"li",className:"contract lighten",events:{click:"showContractWindow"},initialize:function(){this.render()},render:function(){var t=this.model.get("tag"),e=this.model.get("contract_info").name.en+" "+this.model.get("contract_info").tick_length;this.$el.html(t),this.$el.attr("title",e),this.$el.tooltip({position:{my:"left+30 top+30"},track:!0,show:{duration:"fast"},hide:{effect:"hide"},content:function(){return $(this).attr("title")}})},showContractWindow:function(){console.log("showContractWindow(): "+this.model.get("contract_info").name.cht)}}),S.DiscussionView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.model)},tagName:"div",className:"sfo-main",initialize:function(){this.render(),this.listenTo(this.model.get("contracts"),"add",this.addContractView)},render:function(){var t=this;this.$main=this.$el;var e=$('<div class="inliner">');this.$charts=$('<div class="charts" id="charts">'),this.$contracts=$('<ol class="contracts">'),this.$transactions=$('<ol class="transactions">'),e.append(this.$contracts),e.append(this.$transactions),this.$main.append(e),this.$main.append(this.$charts),this.$tabs=$('<ul id="tabs">'),this.$charts.append(this.$tabs),this.$charts.tabs(),this.$charts.find(".chart").css("padding","0px"),this.$charts.find(".ui-tabs-nav").sortable({axis:"x",stop:function(){t.$charts.tabs("refresh")}})},addContractView:function(t){var e=new S.ContractView({model:t});this.$contracts.append(e.$el)}}),S.init_layout=function(){var pstyle="margin: 5px; padding: 5px; font-family: Verdana,Arial,sans-serif; font-size: 11px; border: 1px solid #a6c9e2; background: #fcfdfd; color: #222222; border-radius: 5px;";$("#sfo-layout").w2layout({name:"sfo-layout",padding:1,resizer:3,panels:[{type:"top",minSize:450,size:"70%",resizable:!0,style:pstyle},{type:"main",minSize:150,size:"100%",resizable:!0,style:pstyle}]}),S.layout=S.w2ui["sfo-layout"],S.main_frame=S.$(S.layout.el("top")),S.shell_frame=S.$(S.layout.el("main")),S.discussion_view=new S.DiscussionView({model:S.discussion});var main_div=S.discussion_view.$el;S.main_frame.append(main_div);var shell_div=$('<div class="sfo-shell">');S.shell_frame.append(shell_div);var shell_controller=shell_div.console({promptLabel:"SFO> ",commandHandle:function(line){try{var ret=eval(line);return"undefined"!=typeof ret?ret.toString():!0}catch(err){return[{msg:err.toString(),className:"jquery-console-message-error"}]}},autofocus:!0,animateScroll:!0,promptHistory:!0,welcomeMessage:"Enter some JavaScript expressions to evaluate."})},S.init=function(){try{S.discussion=new S.Discussion,S.init_layout()}catch(t){alert(t)}},this.S=S}();