!function(){var S={version:"0.0.5"};S.$=this.jQuery||this.Zepto||this.ender||this.$,S._=this._,S.B=this.Backbone,S.w2ui=this.w2ui,S.URL_CONTRACT_LIST="/contract_list",S.URL_PRICE="/price",S.CT_STOCK="STOCK",S.CT_FUTURE="FUTURE",S.CT_OPTION="OPTION",S.CT_MERGED="MERGED",S.CT_CMERGED="CMERGED",S.CT_INDICATOR="INDICATOR",S.OT_CALL="C",S.OT_PUT="P",S.PT_OPEN="OPEN",S.PT_HIGH="HIGH",S.PT_LOW="LOW",S.PT_CLOSE="CLOSE",S.PatternRegExpGeneric=/^.+$/,S.PatternContractType=/^(STOCK|FUTURE|OPTION)$/,S.PatternOptionType=/^(C|P)$/,S.PatternTickLength=/^(1S|15S|1M|2M|3M|5M|10M|15M|20M|30M|60M|1D|1W|1N|3N|1Y)$/,S.PatternTradeDate=/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/,S.PatternTradeTime=/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/,S.PatternTradeDay=/^[0-6]$/,S.PatternUnderlyingAssetType=/^(STOCK|FUTURE)$/,S.PatternPriceType=/^(OPEN|HIGH|LOW|CLOSE)$/,S.AC_NATIVE="NATIVE",S.AC_CLONE="CLONE",S.AC_MERGE="MERGE",S.AC_CMERGE="CMERGE",S.AC_INDICATOR="INDICATOR",S._.isInteger=function(t){return S._.isNumber(t)&&Math.floor(t)==t},S.Collection2=S.B.Collection.extend({initialize:function(){this.tagNum=0,this.tagPool=S._.clone({})},getTag:function(){var t=this.tagNum;return this.tagNum++,t+""},add:function(t,e){var n=this;t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=n.getTag();n.tagPool[e]=t,t.set("tag",e)}),S.B.Collection.prototype.add.call(this,t,e)},remove:function(t,e){var n=this;t=S._.isArray(t)?t:[t],S._.each(t,function(t){var e=t.get("tag");delete n.tagPool[e]}),S.B.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.tagNum=0,this.tagPool=S._.clone({}),S.B.Collection.prototype.reset.call(this,t,e)},getModelByTag:function(t){return this.tagPool[t+""]}}),S.B.Validator.add("isNumber",function(t,e){return e===!1||S._.isNumber(t)},"Should be a number"),S.B.Validator.add("isInteger",function(t,e){return e===!1||S._.isInteger(t)},"Should be an integer"),S.IT_MA="MA",S.getIndicatorName_MA=function(t,e){var n=e.price_type,a=e.length,r={en:"MA("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"MA("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_MA=function(t,e){var n=e.price_type,a=e.length,r=t.get("prices").toJSON(),i=S._.map(r,function(t,e,r){var i={trade_time:t.trade_time,ma:null};if(S._.isUndefined(t.trade_date)||(i.trade_date=t.trade_date),S._.isUndefined(t.count_down_days)||(i.count_down_days=t.count_down_days),e-(a-1)>=0){for(var o=0,c=e-(a-1);e>=c;c++)o+=r[c][n];i.ma=o/a}return i});return i},S.IT_EMA="EMA",S.getIndicatorName_EMA=function(t,e){var n=e.price_type,a=e.length,r={en:"EMA("+t.get("contract_info").name.en+", "+n+", "+a+")",cht:"EMA("+t.get("contract_info").name.cht+", "+n+", "+a+")"};return r},S.getIndicatorPrices_EMA=function(t,e){var n=e.price_type,a=e.length,r=t.get("prices").toJSON(),i=0,o=S._.map(r,function(t,e){var r={trade_time:t.trade_time,ema:null};S._.isUndefined(t.trade_date)||(r.trade_date=t.trade_date),S._.isUndefined(t.count_down_days)||(r.count_down_days=t.count_down_days);var o=t[n];return 0==e?i=o:i+=2/(1+a)*(o-i),r.ema=i,r});return o},S.IT_KD="KD",S.getIndicatorName_KD=function(t,e){var n=e.length,a=e.over_sold,r=e.over_bought,i={en:"KD("+t.get("contract_info").name.en+", "+n+", "+a+", "+r+")",cht:"KD("+t.get("contract_info").name.cht+", "+n+", "+a+", "+r+")"};return i},S.getIndicatorPrices_KD=function(t,e){var n=e.length,a=e.over_sold,r=e.over_bought,i=t.get("prices").toJSON(),o=0,c=50,s=50,d=S._.map(i,function(t,e,i){var d={trade_time:t.trade_time,over_sold:a,over_bought:r,rsv:null,k:null,d:null};if(S._.isUndefined(t.trade_date)||(d.trade_date=t.trade_date),S._.isUndefined(t.count_down_days)||(d.count_down_days=t.count_down_days),e-(n-1)>=0){prices_in_len=S._.clone(i).slice(e-(n-1),e+1);var _=S._.max(S._.map(prices_in_len,function(t){return t.high})),l=S._.min(S._.map(prices_in_len,function(t){return t.low}));o=100*((t.close-l)/(_-l)),c=2/3*c+1/3*o,s=2/3*s+1/3*c,d.rsv=o,d.k=c,d.d=s}return d});return d},S.IT_MACD="MACD",S.getIndicatorName_MACD=function(t,e){var n=e.fast,a=e.slow,r=e.length,i={en:"MACD("+t.get("contract_info").name.en+", "+n+", "+a+", "+r+")",cht:"MACD("+t.get("contract_info").name.cht+", "+n+", "+a+", "+r+")"};return i},S.getIndicatorPrices_MACD=function(t,e){var n=e.fast,a=e.slow,r=e.length,i=t.get("prices").toJSON(),o=0,c=0,s=0,d=0,_=0,l=S._.map(i,function(t,e){var i={trade_time:t.trade_time,dif:null,dem:null,osc:null};S._.isUndefined(t.trade_date)||(i.trade_date=t.trade_date),S._.isUndefined(t.count_down_days)||(i.count_down_days=t.count_down_days);var l=(t.high+t.low+2*t.close)/4;return 0==e?(o=l,c=l,s=o-c,d=s):(o+=2/(1+n)*(l-o),c+=2/(1+a)*(l-c),s=o-c,d+=2/(1+r)*(s-d)),_=s-d,i.dif=s,i.dem=d,i.osc=_,i});return l},S.getIndicatorName=function(contract,indicator_type,indicator_param){return eval("S.getIndicatorName_"+indicator_type+"(contract, indicator_param)")},S.getIndicatorPrices=function(contract,indicator_type,indicator_param){return eval("S.getIndicatorPrices_"+indicator_type+"(contract, indicator_param)")},S.Data=S.B.Model.extend({}),S.Datas=S.B.Collection.extend({model:S.Data}),S.Price=S.B.Model.extend({defaults:{trade_time:"00:00:00"},validation:{trade_date:{format:S.PatternTradeDate},count_down_days:{isInteger:!0},trade_time:{required:!0,format:S.PatternTradeTime}}}),S.Prices=S.B.Collection.extend({model:S.Price}),S.Contract=S.B.Model.extend({getMergedPrices:function(t){var e=[];S._.each(t,function(t){e.push(S._.map(t.prices,function(t){return t.trade_date+" "+t.trade_time}))});var n=S._.sortBy(S._.uniq(S._.flatten(e)),function(t){return new Date(t)}),a=[];S._.each(t,function(t){var e=t.factor;a.push(S._.object(S._.map(t.prices,function(t){var n=t.trade_date+" "+t.trade_time;return[n,{trade_date:t.trade_date,trade_time:t.trade_time,open:t.open*e,high:t.high*e,low:t.low*e,close:t.close*e,volume:t.volume*e}]})))});var r=[];return S._.each(n,function(t){var e=t.split(" ")[0],n=t.split(" ")[1];r.push(S._.reduce(a,function(a,r){var i=r[t];return S._.isUndefined(i)?{trade_date:e,trade_time:n,open:null,high:null,low:null,close:null,volume:null}:S._.isNull(a)?S._.clone(i):S._.isNull(a.open)?a:{trade_date:e,trade_time:n,open:a.open+i.open,high:a.high+i.high,low:a.low+i.low,close:a.close+i.close,volume:a.volume+i.volume}},null))}),r},getCMergedPrices:function(t){var e=[];S._.each(t,function(t){e.push(S._.map(t.prices,function(t){return t.count_down_days+" "+t.trade_time}))});var n=S._.sortBy(S._.uniq(S._.flatten(e)),function(t){var e=1*t.split(" ")[0],n=t.split(" ")[1],a=1*n.split(":")[0],r=1*n.split(":")[1],i=1*n.split(":")[2];return 86400*e+3600*a+60*r+1*i}),a=[];S._.each(t,function(t){var e=t.factor;a.push(S._.object(S._.map(t.prices,function(t){var n=t.count_down_days+" "+t.trade_time;return[n,{count_down_days:t.count_down_days,trade_time:t.trade_time,open:t.open*e,high:t.high*e,low:t.low*e,close:t.close*e,volume:t.volume*e}]})))});var r=[];return S._.each(n,function(t){var e=1*t.split(" ")[0],n=t.split(" ")[1];r.push(S._.reduce(a,function(a,r){var i=r[t];return S._.isUndefined(i)?{count_down_days:e,trade_time:n,open:null,high:null,low:null,close:null,volume:null}:S._.isNull(a)?S._.clone(i):S._.isNull(a.open)?a:{count_down_days:e,trade_time:n,open:a.open+i.open,high:a.high+i.high,low:a.low+i.low,close:a.close+i.close,volume:a.volume+i.volume}},null))}),r},loadNative:function(t){var e={exchange:"^"+t.exchange+"$",contract_type:"^"+t.contract_type+"$",contract_name:"^"+t.contract_name+"$"};switch(t.contract_type){case S.CT_STOCK:break;case S.CT_FUTURE:e.contract_date="^"+t.contract_date+"$";break;case S.CT_OPTION:e.contract_date="^"+t.contract_date+"$",e.contract_price_begin=t.contract_price,e.contract_price_end=t.contract_price,e.option_type="^"+t.option_type+"$";break;default:return!1}var n=new S.Datas;if(n.url=S.URL_CONTRACT_LIST,n.fetch({data:{filter:JSON.stringify([e])},async:!1,reset:!0}),n.size()<1)return!1;var a=S._.extend(n.toJSON()[0],t);return this.set("contract_info",a),this.set("prices",new S.Prices),this.get("prices").url=S.URL_PRICE,this.get("prices").fetch({data:t,async:!1,reset:!0}),!0},loadCloned:function(t){var e=t.get("contract_info"),n=t.get("prices").toJSON();this.set("contract_info",e),this.set("prices",new S.Prices(n))},loadMerged:function(t){var e=[],n=[],a=[];S._.each(t,function(t){var r=t.contract,i=t.factor;e.push("("+r.get("contract_info").name.en+")*"+i),n.push("("+r.get("contract_info").name.cht+")*"+i),a.push({prices:r.get("prices").toJSON(),factor:i})});var r={en:e.join(" + "),cht:n.join(" + ")},i=S._.pick(t[0].contract.get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end"),o=S._.extend({name:r,contract_type:S.CT_MERGED,has_trade_date:!0,has_count_down_days:!1},i);this.set("contract_info",o),this.set("prices",new S.Prices(this.getMergedPrices(a)))},loadCMerged:function(t){var e=[],n=[],a=[];S._.each(t,function(t){var r=t.contract,i=t.factor;e.push("("+r.get("contract_info").name.en+")*"+i),n.push("("+r.get("contract_info").name.cht+")*"+i),a.push({prices:r.get("prices").toJSON(),factor:i})});var r={en:e.join(" | "),cht:n.join(" | ")},i=S._.pick(t[0].contract.get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end"),o=S._.extend({name:r,contract_type:S.CT_CMERGED,has_trade_date:!1,has_count_down_days:!0},i);this.set("contract_info",o),this.set("prices",new S.Prices(this.getCMergedPrices(a)))},loadIndicator:function(t,e,n){var a=S.getIndicatorName(t,e,n),r=S._.pick(t.get("contract_info"),"tick_length","trade_day_begin","trade_day_end","trade_date_begin","trade_date_end","trade_time_begin","trade_time_end","has_trade_date","has_count_down_days"),i=S._.extend({name:a,contract_type:S.CT_INDICATOR,indicator_type:e},r);this.set("contract_info",i),this.set("prices",new S.Prices(S.getIndicatorPrices(t,e,n)))}}),S.Contracts=S.Collection2.extend({model:S.Contract}),S.Discussion=S.B.Model.extend({defaults:{contracts:null},initialize:function(){this.set("contracts",new S.Contracts)},_addContract:function(t){this.get("contracts").add(t)},addContract:function(){if(arguments.length<=0)return null;var t=this,e=null,n=arguments[0];switch(n){case S.AC_NATIVE:var a=arguments[1];e=new S.Contract,e.loadNative(a)&&this._addContract(e);break;case S.AC_CLONE:var r=arguments[1],i=this.getContract(r);S._.isNull(i)||(e=new S.Contract,e.loadCloned(i),this._addContract(e));break;case S.AC_MERGE:var o=arguments[1];if(!S._.isArray(o))break;var c=S._.reduce(o,function(e,n){var a=n.tag;return e&&!S._.isUndefined(a)&&!S._.isNull(t.getContract(a))&&t.getContract(a).get("contract_info").has_trade_date===!0},!0);if(c){var s=S._.map(o,function(e){return{contract:t.getContract(e.tag),factor:S._.isNumber(e.factor)?e.factor:1}});e=new S.Contract,e.loadMerged(s),this._addContract(e)}break;case S.AC_CMERGE:var o=arguments[1];if(!S._.isArray(o))break;var c=S._.reduce(o,function(e,n){var a=n.tag;return e&&!S._.isUndefined(a)&&!S._.isNull(t.getContract(a))&&t.getContract(a).get("contract_info").has_count_down_days===!0},!0);if(c){var s=S._.map(o,function(e){return{contract:t.getContract(e.tag),factor:S._.isNumber(e.factor)?e.factor:1}});e=new S.Contract,e.loadCMerged(s),this._addContract(e)}break;case S.AC_INDICATOR:var r=arguments[1],d=arguments[2],_=arguments[3],i=this.getContract(r);S._.isNull(i)||(e=new S.Contract,e.loadIndicator(i,d,_),this._addContract(e))}return e},getContract:function(t){var e=this.get("contracts").getModelByTag(t);return S._.isUndefined(e)&&(e=null),e}}),S.ContractView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},events:{click:"showContractWindow"},initialize:function(){this.render_init()},render_init:function(){this.$el.tooltip({position:{my:"left+30 top+30"},track:!0,show:{duration:"fast"},hide:{effect:"hide"},content:function(){return $(this).attr("title")}})},showContractWindow:function(){console.log("showContractWindow(): "+this.model.get("contract_info").name.cht)}}),S.DiscussionView=S.B.View.extend({isValid:function(){return!S._.isUndefined(this.el)&&!S._.isUndefined(this.model)},initialize:function(){this.render_init(),this.listenTo(this.model.get("contracts"),"add",this.addContractView)},render_init:function(){var t=this;this.$main=this.$el;var e=$('<div class="inliner">');this.$charts=$('<div class="charts" id="charts">'),this.$contracts=$('<ol class="contracts">'),this.$transactions=$('<ol class="transactions">'),e.append(this.$contracts),e.append(this.$transactions),this.$main.append(e),this.$main.append(this.$charts),this.$tabs=$('<ul id="tabs">'),this.$charts.append(this.$tabs),this.$charts.tabs(),this.$charts.find(".chart").css("padding","0px"),this.$charts.find(".ui-tabs-nav").sortable({axis:"x",stop:function(){t.$charts.tabs("refresh")}})},addContractView:function(t){var e=t.get("tag"),n=t.get("contract_info").name.en+" "+t.get("contract_info").tick_length,a=new S.ContractView({el:$('<li class="contract lighten" title="'+n+'">'+e+"</li>"),model:t});this.$contracts.append(a.$el)}}),S.init_layout=function(){var pstyle="margin: 5px; padding: 5px; font-family: Verdana,Arial,sans-serif; font-size: 11px; border: 1px solid #a6c9e2; background: #fcfdfd; color: #222222; border-radius: 5px;";$("#sfo-layout").w2layout({name:"sfo-layout",padding:1,resizer:3,panels:[{type:"top",minSize:450,size:"70%",resizable:!0,style:pstyle},{type:"main",minSize:150,size:"100%",resizable:!0,style:pstyle}]}),S.layout=S.w2ui["sfo-layout"],S.main_frame=S.$(S.layout.el("top")),S.shell_frame=S.$(S.layout.el("main"));var main_div=$('<div class="sfo-main">');S.main_frame.append(main_div),S.discussion_view=new S.DiscussionView({el:main_div,model:S.discussion});var shell_div=$('<div class="sfo-shell">');S.shell_frame.append(shell_div);var shell_controller=shell_div.console({promptLabel:"SFO> ",commandHandle:function(line){try{var ret=eval(line);return"undefined"!=typeof ret?ret.toString():!0}catch(err){return[{msg:err.toString(),className:"jquery-console-message-error"}]}},autofocus:!0,animateScroll:!0,promptHistory:!0,welcomeMessage:"Enter some JavaScript expressions to evaluate."})},S.init=function(){try{S.discussion=new S.Discussion,S.init_layout()}catch(t){alert(t)}},this.S=S}();